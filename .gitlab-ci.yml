stages:
  - test
  - build
  - release

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  GIT_DEPTH: 0  # Disable shallow clone for setuptools_scm

cache:
  paths:
    - .cache/pip

# Test stage - run on branches only (not tags)
test:
  stage: test
  image: python:3.11
  before_script:
    - pip install --upgrade pip
    - pip install pytest flake8
  script:
    - echo "Running syntax check..."
    - python3 -m py_compile gba_tiler.py add_bbox_to_tiles.py test_country_intersection.py
    - echo "Running flake8..."
    - flake8 gba_tiler.py add_bbox_to_tiles.py test_country_intersection.py --max-line-length=88 --ignore=E501,W503 || true
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success
    - if: '$CI_COMMIT_TAG'
      when: never

# Build package - only on tags (excluding dev tags)
build:
  stage: build
  image: python:3.11
  before_script:
    - pip install --upgrade pip
    - pip install build setuptools_scm twine
  script:
    - echo "Building package for $CI_COMMIT_TAG"
    - python -m build
    - twine check dist/*
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    # Match: v1.2.3, v1.2.3a1, v1.2.3-alpha1, v1.2.3b2, v1.2.3-beta2, v1.2.3rc3, v1.2.3-rc3
    # Exclude: v1.2.3dev1, v1.2.3-dev1, v1.2.3.dev1
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+(-(alpha|beta|rc|a|b)\d+|a\d+|b\d+|rc\d+)?$/ && $CI_COMMIT_TAG !~ /dev/'
      when: on_success

# Upload to PyPI - stable releases only
pypi:
  stage: release
  image: python:3.11
  needs:
    - build
  before_script:
    - pip install --upgrade pip twine
  script:
    - echo "Uploading to PyPI..."
    - twine upload dist/* -u __token__ -p $PYPI_TOKEN
  rules:
    # Stable releases: v1.2.3 only
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success
  dependencies:
    - build

# Upload to Test PyPI - pre-release tags
test-pypi:
  stage: release
  image: python:3.11
  needs:
    - build
  before_script:
    - pip install --upgrade pip twine
  script:
    - echo "Uploading to Test PyPI..."
    - twine upload --repository testpypi dist/* -u __token__ -p $TEST_PYPI_TOKEN
  rules:
    # Pre-releases: v1.2.3a1, v1.2.3-alpha1, v1.2.3b2, v1.2.3-beta2, v1.2.3rc3, v1.2.3-rc3
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+(-(alpha|beta|rc|a|b)\d+|a\d+|b\d+|rc\d+)$/ && $CI_COMMIT_TAG !~ /dev/'
      when: on_success
  dependencies:
    - build
  allow_failure: true

# Create GitLab release
gitlab-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - build
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+(-(alpha|beta|rc|a|b)\d+|a\d+|b\d+|rc\d+)?$/ && $CI_COMMIT_TAG !~ /dev/'
      when: on_success
  script:
    - echo "Creating GitLab release for $CI_COMMIT_TAG"
  release:
    tag_name: "$CI_COMMIT_TAG"
    name: "Release $CI_COMMIT_TAG"
    description: |
      Automated release for version $CI_COMMIT_TAG
      
      ## Installation
      
      ```bash
      pip install gba-tiler==$CI_COMMIT_TAG
      ```
      
      ## Changes
      
      See [CHANGELOG](CHANGELOG.md) for details.
    assets:
      links:
        - name: "PyPI Package"
          url: "https://pypi.org/project/gba-tiler/$CI_COMMIT_TAG/"